/**
 * ============================================================================
 * EduHub Centralized Toast Notification System (hot-toast)
 * ============================================================================
 * 
 * Purpose: Unified toast notifications for entire application using hot-toast
 * Location: /common/js/toast-notification.js
 * 
 * Features:
 * - Beautiful, modern toast notifications with hot-toast
 * - URL parameter auto-detection for login/logout/registration messages
 * - Multiple toast types (success, error, warning, info, question)
 * - Mobile responsive with smooth animations
 * - Consistent styling across all pages
 * - Automatically removes previous toasts (maxToasts: 5)
 * 
 * Usage:
 *   Simple: showToast('Message', 'success');
 *   With Duration: showToast('Message', 'info', 3000);
 *   Object API: Toast.success('Message'), Toast.error('Message')
 *   With Options: Toast.success('Message', { duration: 5000 })
 * 
 * Dependencies:
 *   - hot-toast (loaded from CDN via toast-notification.jsp)
 * ============================================================================
 */

// Configure hot-toast with centralized position and settings
if (typeof toast !== 'undefined' && typeof toast.config === 'function') {
    toast.config({
        position: 'top-center',    // Position of toasts
        duration: 4000,            // Duration in milliseconds
        maxToasts: 5,              // Maximum visible toasts
        reverseOrder: false        // Stack order (false = newest on top)
    });
}

// Configuration - All toasts at top center
var TOAST_CONFIG = {
    defaultDuration: 4000,
    position: 'top-center',
    maxToasts: 5,
    reverseOrder: false
};

// Queue for pending toasts when hot-toast is not yet loaded
var toastQueue = [];

/**
 * Process queued toasts once hot-toast is available
 */
function processToastQueue() {
    if (typeof toast !== 'undefined' && toastQueue.length > 0) {
        console.log('Processing ' + toastQueue.length + ' queued toast(s)');
        while (toastQueue.length > 0) {
            var toastItem = toastQueue.shift();
            showToast(toastItem.message, toastItem.type, toastItem.options);
        }
    }
}

/**
 * Main toast function - uses hot-toast
 */
function showToast(message, type, durationOrOptions) {
    type = type || 'info';
    durationOrOptions = durationOrOptions || TOAST_CONFIG.defaultDuration;
    
    // If hot-toast is not loaded yet, queue the toast and try again
    if (typeof toast === 'undefined') {
        console.warn('hot-toast not yet loaded, queuing toast:', message);
        toastQueue.push({ message: message, type: type, options: durationOrOptions });
        
        // Try to process queue after a short delay
        setTimeout(processToastQueue, 100);
        return;
    }
    
    if (type === 'danger') type = 'error';
    
    var options = {};
    if (typeof durationOrOptions === 'number') {
        options.duration = durationOrOptions;
    } else if (typeof durationOrOptions === 'object') {
        options = durationOrOptions;
    }
    
    var duration = options.duration || TOAST_CONFIG.defaultDuration;
    
    try {
        switch(type) {
            case 'success':
                toast.success(message, { duration: duration });
                break;
            case 'error':
                toast.error(message, { duration: duration });
                break;
            case 'warning':
                toast.warning(message, { duration: duration });
                break;
            case 'info':
                toast.info(message, { duration: duration });
                break;
            case 'question':
                toast.info(message, { duration: duration }); // hot-toast doesn't have question, use info
                break;
            default:
                toast(message, { duration: duration });
        }
        console.log('hot-toast displayed:', type, message);
    } catch (error) {
        console.error('Error showing hot-toast:', error);
        alert(message);
    }
}

/**
 * Toast Object API - Convenience methods with advanced features
 */
var Toast = {
    success: function(message, durationOrOptions) {
        return showToast(message, 'success', durationOrOptions);
    },
    
    error: function(message, durationOrOptions) {
        return showToast(message, 'error', durationOrOptions);
    },
    
    warning: function(message, durationOrOptions) {
        return showToast(message, 'warning', durationOrOptions);
    },
    
    info: function(message, durationOrOptions) {
        return showToast(message, 'info', durationOrOptions);
    },
    
    question: function(message, durationOrOptions) {
        return showToast(message, 'question', durationOrOptions);
    },
    
    danger: function(message, durationOrOptions) {
        return showToast(message, 'error', durationOrOptions);
    },
    
    /**
     * Show loading toast
     */
    loading: function(message, options) {
        if (typeof toast === 'undefined') return;
        
        options = options || {};
        var duration = options.duration || 0; // 0 means infinite
        
        return toast.loading(message || 'Loading...', { duration: duration });
    },
    
    /**
     * Dismiss a specific toast by ID
     */
    dismiss: function(toastId) {
        if (typeof toast !== 'undefined' && typeof toast.dismiss === 'function') {
            if (toastId) {
                toast.dismiss(toastId);
            } else {
                // Dismiss all toasts
                toast.dismiss();
            }
        }
    },
    
    /**
     * Remove/dismiss all toasts
     */
    destroyAll: function() {
        if (typeof toast !== 'undefined' && typeof toast.dismiss === 'function') {
            toast.dismiss();
        }
    },
    
    /**
     * Show custom toast with promise support
     */
    promise: function(promise, messages) {
        if (typeof toast !== 'undefined' && typeof toast.promise === 'function') {
            var msgs = messages || {
                loading: 'Loading...',
                success: 'Success!',
                error: 'Error occurred!'
            };
            return toast.promise(promise, msgs);
        }
    }
};

/**
 * Process URL parameters and show appropriate toast notifications
 */
function processUrlParameters() {
    var urlParams = new URLSearchParams(window.location.search);
    var shouldCleanUrl = false;
    
    // Check for registration success
    if (urlParams.has('registered')) {
        var message = urlParams.get('message') || 'Registration successful! Please login with your credentials.';
        showToast(decodeURIComponent(message), 'success');
        shouldCleanUrl = true;
    }
    
    // Check for logout
    if (urlParams.has('logout')) {
        var logoutStatus = urlParams.get('logout');
        if (logoutStatus === 'success' || logoutStatus === 'true') {
            showToast('You have been successfully logged out.', 'success', 3000);
            shouldCleanUrl = true;
        }
    }
    
    // Check for errors
    if (urlParams.has('error')) {
        var errorMsg = urlParams.get('error');
        if (errorMsg === 'invalid') {
            showToast('Invalid credentials. Please try again.', 'error');
        } else if (errorMsg === 'unauthorized') {
            showToast('Please login to access that page.', 'warning', 4000);
        } else {
            showToast(decodeURIComponent(errorMsg), 'error');
        }
        shouldCleanUrl = true;
    }
    
    // Check for success messages
    if (urlParams.has('success')) {
        var successMsg = urlParams.get('success');
        // Handle specific success cases
        if (successMsg === 'login') {
            showToast('Welcome! You have successfully logged in.', 'success', 4000);
        } else if (successMsg === 'logout') {
            showToast('You have been successfully logged out.', 'success', 3000);
        } else {
            // Generic success message or custom decoded message
            showToast(decodeURIComponent(successMsg), 'success');
        }
        shouldCleanUrl = true;
    }
    
    // Check for info messages
    if (urlParams.has('info')) {
        var infoMsg = urlParams.get('info');
        showToast(decodeURIComponent(infoMsg), 'info');
        shouldCleanUrl = true;
    }
    
    // Clean URL parameters after showing toast to prevent duplicate toasts on refresh
    if (shouldCleanUrl && window.history && window.history.replaceState) {
        // Get current URL without query parameters
        var cleanUrl = window.location.protocol + '//' + 
                      window.location.host + 
                      window.location.pathname;
        
        // Replace current history entry without reloading the page
        window.history.replaceState({}, document.title, cleanUrl);
        console.log('URL parameters cleared to prevent duplicate toasts on refresh');
    }
}

/**
 * Initialize toast system with proper timing
 */
function initializeToastSystem() {
    // Check if hot-toast is loaded, if not, wait and retry
    if (typeof toast === 'undefined') {
        setTimeout(initializeToastSystem, 100);
        return;
    }
    
    // Configure hot-toast on initialization
    if (typeof toast.config === 'function') {
        toast.config({
            position: 'top-center',
            duration: 4000,
            maxToasts: 5,
            reverseOrder: false
        });
    }
    
    processUrlParameters();
}

/**
 * Auto-show toast based on URL parameters
 * Use multiple event listeners to ensure it works even after idle time
 */
if (document.readyState === 'loading') {
    // Document still loading, use DOMContentLoaded
    document.addEventListener('DOMContentLoaded', initializeToastSystem);
} else {
    // Document already loaded (e.g., after idle time), run immediately
    initializeToastSystem();
}

// Also try on window load as a fallback
window.addEventListener('load', function() {
    // Only process if not already processed
    var urlParams = new URLSearchParams(window.location.search);
    if (urlParams.has('registered') || urlParams.has('logout') || 
        urlParams.has('error') || urlParams.has('success') || urlParams.has('info')) {
        initializeToastSystem();
    }
});
